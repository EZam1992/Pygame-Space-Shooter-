name: Render PlantUML diagrams

on:
  push:
    branches: [ main ]
    paths:
      - 'diagrams/*.puml'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  render:
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install PlantUML + Graphviz (macOS)
        run: |
          brew update
          brew install graphviz plantuml

      - name: Generate PNG from PUML
        run: |
          mkdir -p diagrams/png

          # Render your PUML (whatever its name is)
          plantuml -tpng diagrams/main.puml -o png

          # Rename output to spaceshooter.png
          if [ -f diagrams/png/main.png ]; then
            mv diagrams/png/main.png diagrams/png/spaceshooter.png
          fi

          echo "Files in diagrams/png:"
          ls -l diagrams/png

      - name: Commit rendered diagram
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update UML diagram"
          file_pattern: diagrams/png/spaceshooter.png
